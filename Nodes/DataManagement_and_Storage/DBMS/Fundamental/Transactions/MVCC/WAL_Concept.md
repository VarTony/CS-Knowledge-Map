---
title: WAL — журнал предзаписи "c высоты птичьего полета" 
---

# WAL

## Мотивация:
**как гарантировать завершённость транзакции, если сбой может произойти в любой момент физической записи данных на диск?**

Запись напрямую в таблицы небезопасна:

* изменения могут быть записаны частично (страница обновилась на половину),
* возможна потеря данных при внезапном отключении питания или сбое диска,
* невозможно откатить транзакцию, если её следы уже попали в таблицу.

Для решения этой проблемы была предложена идея, ставшая одним из фундаметнальных столпов архитектуры во многих СУБД:

> **Перед тем как изменить данные, СУБД должна сначала записать в журнал, что собирается сделать.**
> Это принцип *Write-Ahead Logging* — журнал предзаписи, или WAL.

---

# Что такое WAL

**WAL (Write-Ahead Log)** — это последовательный журнал, куда записываются **все изменения, которые будут произведены транзакцией**, *до того как они применяются к основным данным*.

Запись в WAL производится **атомарно и синхронно на диск**. Только после этого транзакция может считаться завершённой.

---

# Как WAL обеспечивает свойства ACID

```
| Свойство ACID   | Роль WAL                                                                                                                          |
| --------------- | --------------------------------------------------------------------------------------------------------------------------------- |
| **Atomicity**   | Позволяет откатить транзакцию, даже если она начала вносить изменения. Все действия либо применяются, либо отменяются по журналу. |
| **Durability**  | После COMMIT изменения гарантированно записаны в журнал, и их можно восстановить, даже если таблицы ещё не обновлены.             |
| **Isolation**   | Сам WAL не обеспечивает изоляцию, но работает в паре с MVCC, фиксируя версии строк.                                               |
| **Consistency** | WAL обеспечивает физическую согласованность структуры хранения; логическая согласованность достигается через ограничения данных.  |
```
---

# Как происходит COMMIT транзакции в PostgreSQL (пошагово)

```text
1. Клиент выполняет BEGIN; затем один или несколько SQL-операторов.
2. Изменения вносятся во временные буферы и помечаются XID транзакции.
3. Перед завершением транзакции формируется WAL-запись, описывающая эти изменения.
4. WAL-запись синхронно записывается на диск (fsync).
5. Только после успешной записи в WAL транзакция получает статус "committed".
6. Основные данные могут быть записаны позже — асинхронно (checkpoint, background writer).
```

**Ключевой момент:**

> PostgreSQL считает транзакцию завершённой не тогда, когда изменены таблицы, а тогда, когда запись об этих изменениях гарантированно зафиксирована в WAL.

---

# WAL и MVCC: совместная работа

* При каждом INSERT или UPDATE создаётся новая версия кортежа (tuple).
* Эта версия фиксируется в WAL с указанием идентификатора транзакции.
* Только после записи в WAL транзакция становится видимой другим.
* Если произошёл сбой, WAL позволяет:

  * восстановить коммит (REDO),
  * отменить изменения незавершённых транзакций (UNDO).

Таким образом, WAL — это механизм физической надежности, а MVCC — механизм изоляции.

---

# Что происходит при сбое

Если система прерывается в момент выполнения транзакции:

### Транзакция успела записать WAL:

* Но не обновила таблицы → **при запуске система применит WAL и восстановит изменения**.
* Это обеспечивает *Durability*.

### Транзакция не успела записать WAL:

* Никакие изменения не считаются зафиксированными.
* При запуске PostgreSQL откатит незавершённое состояние.
* Это обеспечивает *Atomicity*.

### Транзакция успела изменить таблицы, но не записала WAL:

* Такой сценарий невозможен по архитектуре: **PostgreSQL никогда не пишет данные в таблицу до WAL**.
* Именно поэтому WAL называется "журнал предзаписи".

---

# Итоговая роль WAL в ACID

| Свойство ACID   | Как реализуется через WAL                                                            |
| --------------- | ------------------------------------------------------------------------------------ |
| **Atomicity**   | Если транзакция не успела записать WAL, она не считается выполненной и откатывается. |
| **Durability**  | Если WAL записан — транзакция восстановится при любом сбое.                          |
| **Isolation**   | WAL фиксирует версии данных, которые будут видимы согласно MVCC.                     |
| **Consistency** | Физическая структура данных остаётся согласованной за счёт WAL + восстановления.     |

---

# Вывод

WAL — это фундаментальный механизм, который позволяет PostgreSQL выполнять транзакции так, как будто система *никогда не ошибается*.
Он делает возможным само существование ACID:

* **Транзакции становятся атомарными**, потому что есть точка отката.
* **Коммит становится надёжным**, потому что даже при внезапном сбое информация о нём сохранена.
* **Изменения применяются последовательно**, сохраняя согласованность данных.


## Связанные темы

- [Snapshot](./Snapshot.md)
- [ACID](/Nodes/DataManagement_and_Storage/DBMS/Fundamental/Transactions/ACID.md)


