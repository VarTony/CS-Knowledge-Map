---
title: ACID
---

# ACID: Атомарность, Согласованность, Изоляция, Долговечность.

## Исторический контекст

Впервые в (System R от IBM, Ingres) столкнулись с проблемой, которая тогда носила практический, а не теоретический характер:
**как гарантировать корректность данных при сбоях оборудования и одновременном доступе множества пользователей.**

Транзакции возникли как инженерная необходимость:

> *Не важно, что произошло в системе — питание отключилось, узел отказал, запрос поступил дважды — база данных обязана остаться в корректном состоянии.*

Термин **ACID** появился позже (1983, Haerder & Reuter). Это не акроним, придуманный заранее — это ретроспективное описание принципов, которые уже применялись. Стоит помнить:
**ACID — не «магические свойства СУБД», а договорённость о том, какие гарантии обязана обеспечить транзакция.**

---

# Что такое ACID

| Свойство    | Инженерный смысл                                       | Ключевой механизм в PostgreSQL  |
| ----------- | ------------------------------------------------------ | ------------------------------- |
| Atomicity   | Выполнится всё или ничего                              | WAL + журнал отката (Undo)      |
| Consistency | После транзакции база соответствует бизнес-инвариантам | Constraints, триггеры, FK, MVCC |
| Isolation   | Параллельные транзакции не мешают друг другу           | MVCC, Snapshot, уровни изоляции |
| Durability  | Результат коммита не потеряется                        | WAL, fsync, crash recovery      |

---

# A — Atomicity (Атомарность)

### Смысл

Транзакция не может быть зафиксирована частично. Либо все изменения становятся частью базы данных, либо система возвращается к состоянию до начала транзакции.

### Как реализовано в PostgreSQL

1. Все изменения сначала записываются **в WAL (Write-Ahead Log)**.
2. Только после записи WAL на диск транзакция считается успешно завершённой.
3. Если произошёл сбой до записи в WAL — транзакция будет отменена при восстановлении.
4. Если сбой после записи в WAL — при восстановлении система **повторно применит данные из журнала**, восстанавливая целостность.

### Вывод

> Atomicity — это следствие **журнальной архитектуры**, при которой любое действие фиксируется в журнале до изменения основной структуры данных.

---

# C — Consistency (Согласованность)

### Частое заблуждение

Многие описания объясняют consistency как «данные всегда корректны». Это неверно.
**Consistency — это соблюдение инвариантов, определённых разработчиком.**
Если инварианты не сформулированы с помощью constraint, foreign key или триггеров — база не сможет обеспечить согласованность автоматически.

### Реализация

PostgreSQL проверяет согласованность **в момент COMMIT**:

* ограничения целостности (CHECK, NOT NULL, UNIQUE),
* внешние ключи (FOREIGN KEY),
* пользовательские условия (TRIGGER),
* логическая непротиворечивость данных.

Если транзакция нарушает инвариант — она **не может быть зафиксирована**.

### Вывод

> Consistency — это совместная ответственность системы и разработчика.
> СУБД обеспечивает выполнение правил, но сами правила задаёт архитектура данных.

---

# I — Isolation (Изоляция)

### Определение

Одновременные транзакции не должны влиять друг на друга так, чтобы нарушались их логические ожидания.

Изоляция — единственное свойство ACID, **допускающее уровни ослабления** ради производительности.

### Реализация в PostgreSQL

PostgreSQL использует **MVCC (Multiversion Concurrency Control)**:

* каждая транзакция работает со своей версией данных (snapshot),
* обновления создают новые версии строк, старые остаются доступными для других транзакций,
* блокировки чтения не используются.

Подробно уровни рассмотрены в отдельном документе, здесь важно понимать:

> Isolation — можно сформулировать, что в контексте версионного MVCC, это механизм выбора корректного "временного слоя" данных.

---

# D — Durability (Долговечность)

### Смысл

Если транзакция зафиксирована, её результат **не исчезнет** даже при отключении питания, сбое диска или перезапуске сервера.

### Как PostgreSQL обеспечивает долговечность

1. **Запись в WAL** — это операция журналирования.
   Запись в WAL всегда выполняется **перед внесением изменений в основное хранение**.
2. **fsync** — команда операционной системы, гарантирующая физическую запись данных на диск.
3. **Group commit** — несколько транзакций могут совместно записывать WAL, повышая эффективность.
4. При старте PostgreSQL:

   * если последний WAL-файл не был полностью применён, он **докатывается** (REDO),
   * если обнаружены незавершённые транзакции — они **откатываются** (UNDO).

### Вывод

> Durability — данные гарантированно зафиксированы в WAL и прошли fsync на надёжное устройство.

---

# Почему ACID — это система гарантий, а не просто аббревиатура

* **Atomicity и Durability** обеспечиваются WAL.
* **Isolation** обеспечивается MVCC.
* **Consistency** обеспечивается ограничениями данных и логикой транзакции.

Если разработчик не определил бизнес-инварианты (например, недопустимость отрицательного баланса) — СУБД не будет в состоянии обеспечить consistency, даже если она полностью ACID-совместима.

---

# Итоговая схема (MVCC версионная как PostgreSQL)

```
BEGIN
  → изменения выполняются в буферах
  → WAL фиксирует намерение изменений
  → fsync подтверждает запись
COMMIT
  → изменения становятся видимыми для других транзакций через MVCC
```

---

## Связанные темы

- [Snapshot](./MVCC/Snapshot.md)
- [Версионная реализация MVCC](./MVCC/Vercions.md) TODO
- [Write-Ahead Logging (WAL) и механизм crash recovery](/storage/WAL_and_Crash_Recovery.md)
- [Уровни изоляции транзакций](/transactions/Isolation_Levels.md)

