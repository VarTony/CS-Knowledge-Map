---
title: Heap-файлы PostgreSQL
---

# Heap-файлы PostgreSQL

Когда говорят о “таблице” в PostgreSQL, большинство разработчиков представляют себе логическую структуру: набор строк, 
к которым обращаются через SQL. Но физически таблица — это вовсе не абстрактная сущность. Это **файл на диске**, состоящий из страниц 
фиксированного размера (8 КБ), каждая из которых содержит порцию строк.
В исходниках PostgreSQL этот файл называют **heap relation**, а сам формат — **heap file**.

Слово *heap* здесь не имеет отношения к куче в оперативной памяти. Оно пришло из классической теории систем хранения данных: в 1970-х годах под heap-файлом понимали **неупорядоченное хранилище записей**, куда новые строки просто дописывались в конец, без сортировки. Это был самый универсальный и гибкий способ организации данных: прост в реализации, хорошо работает с индексами, а при добавлении новых строк не требует перестраивать порядок.

---

## Организация страниц

Каждая таблица PostgreSQL представлена на диске как один или несколько файлов (`base/<db_oid>/<relfilenode>`).
Файл разбит на **страницы по 8 КБ**, и именно они — минимальная единица чтения и записи.

Страница содержит:

* служебный заголовок (PageHeaderData),
* массив указателей (line pointer array),
* и сами кортежи — физические строки таблицы.

PostgreSQL не хранит строки последовательно. Наоборот: **внизу страницы находится массив указателей**, а сверху — сами данные. Это позволяет быстро удалять или обновлять записи, не трогая соседние — достаточно пометить pointer как “dead” или заменить его на новую версию (MVCC).

Именно поэтому heap-файлы называют “неупорядоченными”:
физический порядок строк не совпадает с логическим порядком выборки,
и Postgres опирается на индексы, чтобы находить нужные данные.

---

## От страниц к физическому диску

Дальше идёт уровень, который обычно скрыт от СУБД — **файловая система** и устройство хранения.
Каждая страница PostgreSQL занимает несколько **блоков файловой системы** (обычно по 4 КБ).
А уже эти блоки попадают на **сегменты диска** — последовательные участки пластины или ячейки SSD.

Таким образом, цепочка хранения выглядит так:

```
Таблица
 └── Heap-файл (.dat)
       ├── Страницы (8 КБ)
       │     ├── Заголовок
       │     ├── Указатели строк
       │     └── Кортежи (tuples)
       └── ...
Файловая система → Блоки (4 КБ)
Физический диск → Сегменты / Кластеры
```

PostgreSQL не управляет тем, где физически лежат эти блоки — этим занимается ОС.
Но он полностью контролирует структуру страниц и работу с ними: когда страница загружается, меняется, кэшируется и сбрасывается обратно на диск.

---

## Почему именно heap-модель

Когда проектировался PostgreSQL, можно было выбрать один из трёх типов файловой организации:

| Тип             | Принцип                            | Недостаток                            |
| --------------- | ---------------------------------- | ------------------------------------- |
| **Heap**        | Записи добавляются без порядка     | Нужен индекс для быстрых выборок      |
| **Sorted file** | Записи физически упорядочены       | Медленные вставки                     |
| **Hashed file** | Записи распределяются по хэш-ключу | Неэффективен для диапазонных запросов |

Heap оказался естественным выбором. Он прост, не накладывает ограничений на типы данных и прекрасно сочетается с идеологией **MVCC** — многоверсионности строк.
Каждое обновление создаёт новую версию кортежа, а старая просто остаётся на странице, пока её не уберёт VACUUM.
Без heap-модели такая гибкость была бы невозможна.

---

## Heap-файлы и TOAST

Heap-файл — это “основное тело” таблицы.
Когда значение в одной из строк оказывается слишком большим, Postgres не пытается распихать его по страницам файла. Вместо этого он **переносит крупный атрибут во вспомогательную таблицу TOAST**, а в heap-файле оставляет только ссылку.
Это позволяет основным страницам оставаться компактными и быстро читаемыми, а крупные данные хранить отдельно, в своём формате.

---

## Итог

Heap-файл — это фундаментальная часть, на которой держится многое в архитектуре хранения PostgreSQL.
Он не управляет физикой пластин и не знает, где именно лежит блок, но задает **всю внутреннюю логику записи и чтения страниц**.

PostgreSQL вырос в этой концепции — из идеи, что не нужно упорядочивать всё ради абстрактной красоты.
Главное — быстро и надёжно добираться до нужных данных. Так и родился его heap-файл — как тщательно продуманная форма "беспорядка".


## Связанные темы

- [TOAST файлы](./TOAST.md)